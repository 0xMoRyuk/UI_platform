# GTM Drift Detection (Per-App)
#
# Compares local GTM configuration with remote container state for each app.
# Runs weekly to detect out-of-band changes made directly in GTM UI.
#
# Requires:
#   - GOOGLE_APPLICATION_CREDENTIALS secret (service account JSON)
#   - GTM_ACCOUNT_ID secret
#   - GTM_CONTAINER_ID_WEB, GTM_CONTAINER_ID_AI4SU, GTM_CONTAINER_ID_SANDBOX secrets

name: GTM Drift Detection

on:
  schedule:
    # Weekly on Monday at 6am UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    inputs:
      app:
        description: "App to check (leave empty for all apps)"
        required: false
        default: ""
        type: string
      fix_drift:
        description: "Auto-fix drift by syncing local config to GTM"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: read
  issues: write

env:
  GTM_ACCOUNT_ID: ${{ secrets.GTM_ACCOUNT_ID }}

jobs:
  detect-drift:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [web, ai4su, designOS_sandbox]
      fail-fast: false
    # Skip app if specific app requested and this isn't it
    if: ${{ github.event.inputs.app == '' || github.event.inputs.app == matrix.app }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install tagmanager2 CLI
        run: cargo install google-tagmanager2-cli

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Get container ID for app
        id: container
        run: |
          APP="${{ matrix.app }}"
          APP_UPPER=$(echo "$APP" | tr '[:lower:]' '[:upper:]' | tr '-' '_')

          # Map app name to secret name
          case "$APP" in
            web)
              CONTAINER_ID="${{ secrets.GTM_CONTAINER_ID_WEB }}"
              ;;
            ai4su)
              CONTAINER_ID="${{ secrets.GTM_CONTAINER_ID_AI4SU }}"
              ;;
            designOS_sandbox)
              CONTAINER_ID="${{ secrets.GTM_CONTAINER_ID_SANDBOX }}"
              ;;
          esac

          if [ -z "$CONTAINER_ID" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Container ID not configured for $APP, skipping..."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "container_id=$CONTAINER_ID" >> $GITHUB_OUTPUT
          fi

      - name: Export current GTM state
        if: steps.container.outputs.skip == 'false'
        id: export
        run: |
          APP="${{ matrix.app }}"
          mkdir -p .gtm-remote/$APP

          # Export tags
          tagmanager2 accounts containers-workspaces-tags-list \
            --account-id=$GTM_ACCOUNT_ID \
            --container-id=${{ steps.container.outputs.container_id }} \
            --workspace-id=default \
            --output-format=json > .gtm-remote/$APP/tags.json 2>/dev/null || echo "[]" > .gtm-remote/$APP/tags.json

          # Export triggers
          tagmanager2 accounts containers-workspaces-triggers-list \
            --account-id=$GTM_ACCOUNT_ID \
            --container-id=${{ steps.container.outputs.container_id }} \
            --workspace-id=default \
            --output-format=json > .gtm-remote/$APP/triggers.json 2>/dev/null || echo "[]" > .gtm-remote/$APP/triggers.json

          # Export variables
          tagmanager2 accounts containers-workspaces-variables-list \
            --account-id=$GTM_ACCOUNT_ID \
            --container-id=${{ steps.container.outputs.container_id }} \
            --workspace-id=default \
            --output-format=json > .gtm-remote/$APP/variables.json 2>/dev/null || echo "[]" > .gtm-remote/$APP/variables.json

      - name: Compare configurations
        if: steps.container.outputs.skip == 'false'
        id: compare
        run: |
          APP="${{ matrix.app }}"
          DRIFT_DETECTED=false
          DRIFT_SUMMARY=""

          # Count local resources (app-specific + shared)
          LOCAL_TAGS=$(ls -1 .claude/config/gtm/$APP/tags/*.json 2>/dev/null | wc -l | tr -d ' ')
          LOCAL_TRIGGERS=$(ls -1 .claude/config/gtm/shared/triggers/*.json 2>/dev/null | wc -l | tr -d ' ')
          LOCAL_VARS_SHARED=$(jq -s 'map(.variables // []) | flatten | length' .claude/config/gtm/shared/variables/*.json 2>/dev/null || echo "0")
          LOCAL_VARS_APP=$(ls -1 .claude/config/gtm/$APP/variables/*.json 2>/dev/null | wc -l | tr -d ' ')
          LOCAL_VARS=$((LOCAL_VARS_SHARED + LOCAL_VARS_APP))

          # Count remote resources
          REMOTE_TAGS=$(jq 'if type == "array" then length else 0 end' .gtm-remote/$APP/tags.json)
          REMOTE_TRIGGERS=$(jq 'if type == "array" then length else 0 end' .gtm-remote/$APP/triggers.json)
          REMOTE_VARS=$(jq 'if type == "array" then length else 0 end' .gtm-remote/$APP/variables.json)

          # Compare
          if [ "$LOCAL_TAGS" != "$REMOTE_TAGS" ]; then
            DRIFT_DETECTED=true
            DRIFT_SUMMARY+="Tags: $LOCAL_TAGS local vs $REMOTE_TAGS remote\n"
          fi

          if [ "$LOCAL_TRIGGERS" != "$REMOTE_TRIGGERS" ]; then
            DRIFT_DETECTED=true
            DRIFT_SUMMARY+="Triggers: $LOCAL_TRIGGERS local vs $REMOTE_TRIGGERS remote\n"
          fi

          if [ "$LOCAL_VARS" != "$REMOTE_VARS" ]; then
            DRIFT_DETECTED=true
            DRIFT_SUMMARY+="Variables: $LOCAL_VARS local vs $REMOTE_VARS remote\n"
          fi

          echo "drift_detected=$DRIFT_DETECTED" >> $GITHUB_OUTPUT
          echo "drift_summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$DRIFT_SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create issue on drift
        if: steps.container.outputs.skip == 'false' && steps.compare.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const app = '${{ matrix.app }}';
            const title = `GTM Configuration Drift Detected: ${app}`;
            const body = `## GTM Configuration Drift: ${app}

            The GTM container configuration for **${app}** has drifted from the local configuration.

            ### Summary
            \`\`\`
            ${{ steps.compare.outputs.drift_summary }}
            \`\`\`

            ### Container Details
            - Container ID: \`${{ steps.container.outputs.container_id }}\`
            - Config path: \`.claude/config/gtm/${app}/\`

            ### Actions Required
            1. Review changes made directly in GTM UI
            2. Either:
               - Update local config to match remote (if changes are intentional)
               - Run \`/gtm sync ${app}\` to push local config to GTM (if remote changes should be reverted)

            ### Automation
            Re-run this workflow with \`app: ${app}\` and \`fix_drift: true\` to auto-sync local config.

            ---
            *This issue was created automatically by the GTM Drift Detection workflow.*
            `;

            const labels = ['gtm-drift', 'analytics', app];

            // Check if issue already exists for this app
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: `gtm-drift,${app}`
            });

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels
              });
            } else {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: body
              });
            }

      - name: Auto-fix drift
        if: ${{ github.event.inputs.fix_drift == 'true' && steps.container.outputs.skip == 'false' && steps.compare.outputs.drift_detected == 'true' }}
        run: |
          APP="${{ matrix.app }}"
          echo "Auto-fixing drift for $APP by syncing local config to GTM..."
          echo "Would sync:"
          echo "- Shared triggers from .claude/config/gtm/shared/triggers/"
          echo "- Shared variables from .claude/config/gtm/shared/variables/"
          echo "- App tags from .claude/config/gtm/$APP/tags/"
          echo "- App variables from .claude/config/gtm/$APP/variables/"

      - name: Report status
        if: steps.container.outputs.skip == 'false' && steps.compare.outputs.drift_detected == 'false'
        run: |
          echo "No drift detected for ${{ matrix.app }}. Local and remote configurations are in sync."
